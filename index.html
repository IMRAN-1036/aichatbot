<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI Girlfriend Voice Assistant</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        color: #333;
      }
      h1 {
        color: #ff69b4;
        font-size: 2.5em;
        margin-bottom: 20px;
      }
      .controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
      }
      button {
        padding: 12px 24px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 25px;
        background: #ff69b4;
        color: white;
        transition: background 0.3s, transform 0.1s;
      }
      button:hover {
        background: #ff1493;
        transform: scale(1.05);
      }
      button:active {
        transform: scale(0.95);
      }
      #chat-container {
        max-width: 600px;
        margin: 0 auto 20px;
        padding: 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        height: 400px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .message {
        padding: 10px 15px;
        margin: 10px 0;
        border-radius: 20px;
        max-width: 80%;
        word-wrap: break-word;
      }
      .user-message {
        background: #d1e7dd;
        align-self: flex-end;
      }
      .ai-message {
        background: #f8d7da;
        align-self: flex-start;
      }
      audio {
        width: 100%;
        max-width: 300px;
        margin: 10px auto;
        display: block;
      }
      #status {
        font-style: italic;
        color: #666;
        margin-bottom: 10px;
      }
      .extra-features {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 15px;
      }
      select {
        padding: 8px 12px;
        border-radius: 20px;
        border: 1px solid #ccc;
        background: white;
      }
    </style>
  </head>
  <body>
    <h1>üéôÔ∏è AI Girlfriend Assistant</h1>
    <div id="status">Say something...</div>
    <div class="controls">
      <button id="startBtn">Start Listening</button>
      <button id="stopBtn" disabled>Stop Listening</button>
    </div>
    <div id="chat-container"></div>
    <audio id="audio" controls></audio>

    <div class="extra-features">
      <label for="voiceSelect">Choose Voice:</label>
      <select id="voiceSelect">
        <option value="alloy">Alloy</option>
        <option value="echo">Echo</option>
        <option value="fable">Fable</option>
        <option value="onyx">Onyx</option>
        <option value="nova">Nova</option>
        <option value="shimmer">Shimmer</option>
      </select>
    </div>

    <script>
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      const chatContainer = document.getElementById("chat-container");
      const status = document.getElementById("status");
      const GEMINI_API_KEY = "AIzaSyBKVWIg67g5jHKXGrNx9PJCIi-eGCl0uQs"; // Verify this key is valid
      const voiceSelect = document.getElementById("voiceSelect");

      if (!SpeechRecognition) {
        status.textContent =
          "‚ùå SpeechRecognition not supported in this browser.";
      } else {
        const r = new SpeechRecognition();
        r.continuous = false;
        r.interimResults = false;
        r.maxAlternatives = 1;

        document.getElementById("startBtn").onclick = () => {
          r.start();
          document.getElementById("stopBtn").disabled = false;
        };

        document.getElementById("stopBtn").onclick = () => {
          r.stop();
          document.getElementById("stopBtn").disabled = true;
        };

        r.onstart = () => {
          status.textContent = "üéß Listening...";
        };

        r.onend = () => {
          status.textContent = "Stopped listening.";
          document.getElementById("stopBtn").disabled = true;
        };

        r.onresult = async (event) => {
          const transcript = event.results[0][0].transcript;
          addMessage("user", "üó£Ô∏è You: " + transcript);

          try {
            // Get AI text reply
            const result = await callGeminiText(transcript);
            console.log(
              "Gemini text response:",
              JSON.stringify(result, null, 2)
            );

            let text = "‚ö†Ô∏è No reply";
            if (
              result.candidates &&
              result.candidates[0]?.content?.parts?.[0]?.text
            ) {
              text = result.candidates[0].content.parts[0].text;
            } else {
              console.error("Unexpected response structure:", result);
              status.textContent = "‚ùå Unexpected response from Gemini API";
              return;
            }
            addMessage("ai", "ü§ñ Her: " + text);

            // Convert text to speech using Web Speech API
            await speakText(text);
          } catch (err) {
            console.error("Gemini error:", err);
            status.textContent = "‚ùå Error from Gemini API: " + err.message;
          }
        };
      }

      // Function to add messages to chat
      function addMessage(type, content) {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", type + "-message");
        msgDiv.textContent = content;
        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Gemini Text Generation
      async function callGeminiText(userText) {
        const body = {
          contents: [
            {
              parts: [
                {
                  text: `You are an AI girlfriend of Imran. Reply short and emotional ‚Äî 1-3 short sentences max. User input: ${userText}`,
                },
              ],
            },
          ],
        };

        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          }
        );

        if (!response.ok) {
          const errorText = await response.text();
          console.error("Full API error:", errorText);
          throw new Error(`HTTP error! Status: ${response.status} - ${errorText}`);
        }

        return await response.json();
      }

      // Web Speech API for TTS
      async function speakText(text) {
        try {
          const utterance = new SpeechSynthesisUtterance(text);
          const selectedVoice = voiceSelect.value;
          const voices = window.speechSynthesis.getVoices();

          // Try to match the selected voice (basic mapping; browser-dependent)
          let voice = voices.find((v) => v.name.toLowerCase().includes(selectedVoice.toLowerCase()));
          if (!voice) {
            voice = voices[0]; // Fallback to default voice
            console.warn(`Voice "${selectedVoice}" not found, using default voice.`);
          }

          utterance.voice = voice;
          utterance.rate = 1.0;
          utterance.pitch = 1.0;
          utterance.volume = 1.0;

          // Cancel any ongoing speech
          window.speechSynthesis.cancel();

          // Play the utterance
          window.speechSynthesis.speak(utterance);

          // Return a promise that resolves when speech ends
          return new Promise((resolve, reject) => {
            utterance.onend = resolve;
            utterance.onerror = (err) => {
              console.error("Speech synthesis error:", err);
              reject(new Error("Error in speech synthesis"));
            };
          });
        } catch (err) {
          console.error("TTS error:", err);
          status.textContent = "‚ùå Error generating speech: " + err.message;
        }
      }

      // Load voices when available (some browsers load voices asynchronously)
      window.speechSynthesis.onvoiceschanged = () => {
        const voices = window.speechSynthesis.getVoices();
        console.log("Available voices:", voices);
      };
    </script>
  </body>
</html>